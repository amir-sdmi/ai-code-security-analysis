// Generated by Copilot - Variabili globali per gestione questionari e domande
let currentUser = null;
let currentPage = 'home';
let questions = [];
let editingSurveyId = null;
let editingQuestionIndex = null; // Per tracciare quale domanda si sta modificando

// Inizializzazione dell'applicazione
document.addEventListener('DOMContentLoaded', function() {
    // Gestione della navigazione
    setupNavigation();
    
    // Gestione dell'autenticazione
    setupAuth();
    
    // Gestione dei questionari
    setupSurveyCreation();
    
    // Gestione dei risultati
    setupResults();
    
    // Generated by Copilot - Inizializza animazioni menu
    initializeMenuAnimations();
    
    // Imposta la pagina home come attiva all'avvio
    updateActiveMenuItem('home');
    
    // Carica i dati iniziali
    loadInitialData();
});

// Funzioni di navigazione
function setupNavigation() {
    // Gestione dei link di navigazione
    document.querySelectorAll('[data-page]').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            navigateTo(this.getAttribute('data-page'));
        });
    });
    
    // Pulsanti aggiuntivi di navigazione
    document.getElementById('home-create-btn').addEventListener('click', () => {
        editingSurveyId = null; // Generated by Copilot - Assicurati che stiamo creando un nuovo questionario
        navigateTo('create-survey');
    });
    document.getElementById('home-browse-btn').addEventListener('click', () => navigateTo('surveys'));
    document.getElementById('new-survey-btn').addEventListener('click', () => {
        editingSurveyId = null; // Generated by Copilot - Assicurati che stiamo creando un nuovo questionario
        navigateTo('create-survey');
    });
    document.getElementById('back-to-surveys-btn').addEventListener('click', () => navigateTo('surveys'));
    document.getElementById('back-from-results-btn').addEventListener('click', () => navigateTo('results'));
    document.getElementById('cancel-survey-btn').addEventListener('click', () => navigateTo('surveys'));
}

function navigateTo(page) {
    console.log('ðŸ§­ navigateTo called with page:', page, 'editingSurveyId:', editingSurveyId); // Generated by Copilot - Debug log
    
    // Nascondi tutte le pagine
    document.querySelectorAll('.page').forEach(p => p.classList.add('d-none'));
    
    // Mostra la pagina richiesta
    document.getElementById(page + '-page').classList.remove('d-none');
    console.log('ðŸ‘ï¸ Page', page, 'is now visible');
    
    // Generated by Copilot - Aggiorna indicatore menu attivo
    updateActiveMenuItem(page);
    
    // Aggiorna la pagina corrente
    currentPage = page;
    
    // Generated by Copilot - Azioni specifiche per pagina (evita reset se stiamo modificando)
    if (page === 'surveys') {
        loadUserSurveys();
    } else if (page === 'create-survey') {
        // Reset solo se NON stiamo modificando un questionario esistente
        if (!editingSurveyId) {
            console.log('ðŸ”„ Calling resetSurveyForm because editingSurveyId is null');
            resetSurveyForm();
        } else {
            console.log('ðŸ“ Skipping resetSurveyForm because we are editing survey ID:', editingSurveyId);
            // Assicurati che la UI mostri la modalitÃ  modifica
            const modeText = document.getElementById('survey-mode-text');
            const editingIndicator = document.getElementById('editing-indicator');
            
            if (modeText) {
                modeText.textContent = 'Modifica questionario';
            }
            
            if (editingIndicator) {
                editingIndicator.style.display = 'inline';
            }
        }
    } else if (page === 'results') {
        loadSurveysForResults();
    }
}

// Funzioni di autenticazione
function setupAuth() {
    // Gestione login
    document.getElementById('login-submit').addEventListener('click', handleLogin);
    
    // Gestione registrazione
    document.getElementById('register-submit').addEventListener('click', handleRegister);
    
    // Gestione logout
    document.getElementById('logout-btn').addEventListener('click', handleLogout);
    
    // Controlla se l'utente Ã¨ giÃ  loggato (dal localStorage)
    checkLoggedInUser();
}

function handleLogin() {
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    
    if (!username || !password) {
        showLoginError('Inserisci username e password');
        return;
    }
    
    // Chiamata API per il login
    fetch('/api/login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username, password })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Credenziali non valide');
        }
        return response.json();
    })
    .then(data => {
        // Salva i dati utente
        currentUser = {
            id: data.id,
            username: data.username,
            email: data.email,
            isAdmin: data.is_admin
        };
        
        // Salva nel localStorage
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        // Aggiorna UI
        updateAuthUI();
        
        // Chiudi il modal
        const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
        loginModal.hide();
        
        // Mostra messaggio di successo
        showAlert('Login effettuato con successo', 'success');
        
        // Carica i questionari dell'utente
        loadUserSurveys();
    })
    .catch(error => {
        showLoginError(error.message);
    });
}

function handleRegister() {
    const username = document.getElementById('register-username').value;
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const confirmPassword = document.getElementById('register-confirm-password').value;
    
    // Validazione
    if (!username || !email || !password) {
        showRegisterError('Tutti i campi sono obbligatori');
        return;
    }
    
    if (password !== confirmPassword) {
        showRegisterError('Le password non coincidono');
        return;
    }
    
    // Chiamata API per la registrazione
    fetch('/api/users', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username, email, password })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || 'Errore durante la registrazione');
            });
        }
        return response.json();
    })
    .then(data => {
        // Chiudi il modal
        const registerModal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
        registerModal.hide();
        
        // Mostra messaggio di successo
        showAlert('Registrazione completata con successo. Ora puoi effettuare il login.', 'success');
        
        // Apri il modal di login
        const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        loginModal.show();
    })
    .catch(error => {
        showRegisterError(error.message);
    });
}

function handleLogout() {
    // Rimuovi i dati utente
    currentUser = null;
    localStorage.removeItem('currentUser');
    
    // Aggiorna UI
    updateAuthUI();
    
    // Torna alla home
    navigateTo('home');
    
    // Mostra messaggio
    showAlert('Logout effettuato con successo', 'info');
}

function checkLoggedInUser() {
    const savedUser = localStorage.getItem('currentUser');
    console.log('Checking logged in user, savedUser:', savedUser); // Generated by Copilot - Debug log
    
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        console.log('User restored from localStorage:', currentUser); // Generated by Copilot - Debug log
        updateAuthUI();
    }
}

function updateAuthUI() {
    if (currentUser) {
        // Mostra info utente
        document.getElementById('auth-buttons').classList.add('d-none');
        document.getElementById('user-info').classList.remove('d-none');
        document.getElementById('username-display').textContent = currentUser.username;
    } else {
        // Mostra pulsanti login/register
        document.getElementById('auth-buttons').classList.remove('d-none');
        document.getElementById('user-info').classList.add('d-none');
    }
}

function showLoginError(message) {
    const errorElement = document.getElementById('login-error');
    errorElement.textContent = message;
    errorElement.classList.remove('d-none');
}

function showRegisterError(message) {
    const errorElement = document.getElementById('register-error');
    errorElement.textContent = message;
    errorElement.classList.remove('d-none');
}

// Funzioni per la gestione dei questionari
function setupSurveyCreation() {
    // Gestione del form per aggiungere domande
    document.getElementById('add-question-btn').addEventListener('click', showQuestionModal);
    document.getElementById('question-type').addEventListener('change', toggleOptionsContainer);
    document.getElementById('add-option-btn').addEventListener('click', addOptionInput);
    document.getElementById('save-question-btn').addEventListener('click', addQuestionToSurvey);
    
    // Gestione del salvataggio del questionario
    document.getElementById('save-survey-btn').addEventListener('click', saveSurvey);
    
    // Gestione della compilazione del questionario
    document.getElementById('submit-survey-btn').addEventListener('click', submitSurveyResponse);
}

function showQuestionModal() {
    // Generated by Copilot - Reset del form e dello stato di modifica
    document.getElementById('question-form').reset();
    document.getElementById('options-container').classList.add('d-none');
    document.getElementById('options-list').innerHTML = '';
    editingQuestionIndex = null; // Reset dello stato di modifica
    
    // Ripristina il testo del pulsante
    document.getElementById('save-question-btn').textContent = 'Aggiungi Domanda';
    
    // Mostra il modal
    const questionModal = new bootstrap.Modal(document.getElementById('questionModal'));
    questionModal.show();
}

function toggleOptionsContainer() {
    const questionType = document.getElementById('question-type').value;
    const optionsContainer = document.getElementById('options-container');
    
    if (questionType === 'single_choice' || questionType === 'multiple_choice') {
        optionsContainer.classList.remove('d-none');
    } else {
        optionsContainer.classList.add('d-none');
    }
}

function addOptionInput() {
    const optionsList = document.getElementById('options-list');
    const optionCount = optionsList.children.length + 1;
    
    const optionDiv = document.createElement('div');
    optionDiv.className = 'input-group mb-2';
    optionDiv.innerHTML = `
        <input type="text" class="form-control option-input" placeholder="Opzione ${optionCount}" required>
        <button class="btn btn-outline-danger remove-option" type="button">
            <i class="bi bi-trash"></i>
        </button>
    `;
    
    optionsList.appendChild(optionDiv);
    
    // Aggiungi event listener per rimuovere l'opzione
    optionDiv.querySelector('.remove-option').addEventListener('click', function() {
        optionDiv.remove();
    });
}

function addQuestionToSurvey() {
    const questionText = document.getElementById('question-text').value;
    const questionType = document.getElementById('question-type').value;
    const required = document.getElementById('question-required').checked;
    
    if (!questionText) {
        showAlert('Inserisci il testo della domanda', 'danger');
        return;
    }
    
    let options = [];
    if (questionType === 'single_choice' || questionType === 'multiple_choice') {
        const optionInputs = document.querySelectorAll('.option-input');
        optionInputs.forEach(input => {
            if (input.value.trim()) {
                options.push(input.value.trim());
            }
        });
        
        if (options.length < 2) {
            showAlert('Inserisci almeno due opzioni', 'danger');
            return;
        }
    }

    // Generated by Copilot - Gestione sia aggiunta che modifica domande
    const questionData = {
        id: editingQuestionIndex !== null ? questions[editingQuestionIndex].id : Date.now(), // Usa ID esistente o genera nuovo
        text: questionText,
        question_type: questionType,
        required: required,
        options: options
    };
    
    if (editingQuestionIndex !== null) {
        // Stiamo modificando una domanda esistente
        questions[editingQuestionIndex] = questionData;
        editingQuestionIndex = null; // Reset dello stato di modifica
        showAlert('Domanda aggiornata con successo', 'success');
    } else {
        // Stiamo aggiungendo una nuova domanda
        questions.push(questionData);
        showAlert('Domanda aggiunta con successo', 'success');
    }
    
    // Aggiorna la UI
    renderQuestions();
    
    // Chiudi il modal
    const questionModal = bootstrap.Modal.getInstance(document.getElementById('questionModal'));
    questionModal.hide();
}

function renderQuestions() {
    const container = document.getElementById('questions-container');
    const noQuestionsMessage = document.getElementById('no-questions-message');
    
    if (questions.length === 0) {
        noQuestionsMessage.classList.remove('d-none');
        return;
    }
    
    noQuestionsMessage.classList.add('d-none');
    
    // Rimuovi le domande esistenti
    const existingQuestions = container.querySelectorAll('.question-card');
    existingQuestions.forEach(q => q.remove());
    
    // Aggiungi le domande
    questions.forEach((question, index) => {
        const card = document.createElement('div');
        card.className = 'card question-card mb-3';
        card.dataset.questionId = question.id;
        card.dataset.questionIndex = index;
        card.draggable = true; // Generated by Copilot - Abilita drag-and-drop
        
        let optionsHtml = '';
        if (question.question_type === 'single_choice' || question.question_type === 'multiple_choice') {
            optionsHtml = '<div class="mt-3"><strong>Opzioni:</strong><ul>';
            question.options.forEach(option => {
                optionsHtml += `<li>${option}</li>`;
            });
            optionsHtml += '</ul></div>';
        }
        
        let questionTypeBadge = '';
        switch (question.question_type) {
            case 'text':
                questionTypeBadge = '<span class="badge bg-info">Testo</span>';
                break;
            case 'single_choice':
                questionTypeBadge = '<span class="badge bg-primary">Scelta singola</span>';
                break;
            case 'multiple_choice':
                questionTypeBadge = '<span class="badge bg-success">Scelta multipla</span>';
                break;
            case 'rating':
                questionTypeBadge = '<span class="badge bg-warning">Valutazione</span>';
                break;
        }
        
        card.innerHTML = `
            <div class="card-body">
                <div class="question-header">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-grip-vertical drag-handle" title="Trascina per riordinare"></i>
                        <h5 class="card-title mb-0">Domanda ${index + 1} ${question.required ? '<span class="text-danger">*</span>' : ''}</h5>
                    </div>
                    <div>
                        ${questionTypeBadge}
                        ${question.required ? '<span class="badge bg-danger ms-1">Obbligatoria</span>' : ''}
                    </div>
                </div>
                <p class="card-text mt-3">${question.text}</p>
                ${optionsHtml}
                <div class="question-actions d-flex justify-content-end mt-3">
                    <button class="btn btn-sm btn-outline-primary edit-question" data-question-index="${index}">
                        <i class="bi bi-pencil"></i> Modifica
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-question" data-question-id="${question.id}">
                        <i class="bi bi-trash"></i> Elimina
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(card);
        
        // Generated by Copilot - Event listeners per modifica e eliminazione domande
        // Aggiungi event listener per modificare la domanda
        card.querySelector('.edit-question').addEventListener('click', function() {
            editQuestion(this.getAttribute('data-question-index'));
        });
        
        // Aggiungi event listener per eliminare la domanda
        card.querySelector('.delete-question').addEventListener('click', function() {
            deleteQuestion(this.getAttribute('data-question-id'));
        });
        
        // Generated by Copilot - Event listeners per drag-and-drop
        // Drag and drop event listeners
        card.addEventListener('dragstart', function(e) {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
            e.dataTransfer.setData('text/plain', this.dataset.questionIndex);
            this.classList.add('dragging');
        });
        
        card.addEventListener('dragend', function() {
            this.classList.remove('dragging');
        });
        
        card.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        });
        
        card.addEventListener('dragleave', function() {
            this.classList.remove('drag-over');
        });
        
        card.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const targetIndex = parseInt(this.dataset.questionIndex);
            
            if (draggedIndex !== targetIndex) {
                // Riordina l'array delle domande
                const draggedQuestion = questions[draggedIndex];
                questions.splice(draggedIndex, 1);
                questions.splice(targetIndex, 0, draggedQuestion);
                
                // Ri-renderizza le domande
                renderQuestions();
                
                showAlert('Domande riordinate con successo', 'info');
            }
        });
    });
}

// Generated by Copilot - Funzione per modificare una domanda esistente
function editQuestion(questionIndex) {
    const question = questions[questionIndex];
    editingQuestionIndex = questionIndex;
    
    // Popola il form del modal con i dati della domanda esistente
    document.getElementById('question-text').value = question.text;
    document.getElementById('question-type').value = question.question_type
    document.getElementById('question-required').checked = question.required;
    
    // Gestisci le opzioni se presenti
    const optionsContainer = document.getElementById('options-container');
    const optionsList = document.getElementById('options-list');
    optionsList.innerHTML = ''; // Pulisci le opzioni esistenti
    
    if (question.question_type === 'single_choice' || question.question_type === 'multiple_choice') {
        optionsContainer.classList.remove('d-none');
        
        // Aggiungi le opzioni esistenti
        question.options.forEach((option, index) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'input-group mb-2';
            optionDiv.innerHTML = `
                <input type="text" class="form-control option-input" placeholder="Opzione ${index + 1}" value="${option}" required>
                <button class="btn btn-outline-danger remove-option" type="button">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            
            optionsList.appendChild(optionDiv);
            
            // Aggiungi event listener per rimuovere l'opzione
            optionDiv.querySelector('.remove-option').addEventListener('click', function() {
                optionDiv.remove();
            });
        });
    } else {
        optionsContainer.classList.add('d-none');
    }
    
    // Cambia il testo del pulsante per indicare che stiamo modificando
    document.getElementById('save-question-btn').textContent = 'Aggiorna Domanda';
    
    // Mostra il modal
    const questionModal = new bootstrap.Modal(document.getElementById('questionModal'));
    questionModal.show();
}

function deleteQuestion(questionId) {
    // Generated by Copilot - Conferma eliminazione con messaggio specifico
    const questionToDelete = questions.find(q => q.id == questionId);
    const questionText = questionToDelete ? questionToDelete.text.substring(0, 50) + '...' : 'questa domanda';
    
    if (!confirm(`Sei sicuro di voler eliminare "${questionText}"?`)) {
        return;
    }
    
    questions = questions.filter(q => q.id != questionId);
    renderQuestions();
    showAlert('Domanda eliminata con successo', 'info');
}

function saveSurvey() {
    if (!currentUser) {
        showAlert('Devi effettuare il login per creare un questionario', 'danger');
        return;
    }
    
    const title = document.getElementById('survey-title').value;
    const description = document.getElementById('survey-description').value;
    const isActive = document.getElementById('survey-active').checked;
    const expiresAt = document.getElementById('survey-expires').value;
    
    if (!title) {
        showAlert('Inserisci il titolo del questionario', 'danger');
        return;
    }
    
    if (questions.length === 0) {
        showAlert('Aggiungi almeno una domanda al questionario', 'danger');
        return;
    }
    
    // Generated by Copilot - Prepara i dati del questionario con supporto intelligente per modifica
    const surveyData = {
        title: title,
        description: description,
        is_active: isActive,
        expires_at: expiresAt || null,
        creator_id: currentUser.id,
        questions: questions.map(q => {
            const questionData = {
                text: q.text,
                question_type: q.question_type,
                required: q.required,
                options: q.options
            };
            
            // Includi l'ID solo se Ã¨ un ID reale dal database (non un timestamp temporaneo)
            // Gli ID dal database sono solitamente piccoli numeri interi, i timestamp sono molto grandi
            if (q.id && q.id < 1000000) { // ID del database sono tipicamente < 1 milione
                questionData.id = q.id;
            }
            
            return questionData;
        })
    };
    
    // Determina se Ã¨ una creazione o un aggiornamento
    const method = editingSurveyId ? 'PUT' : 'POST';
    const url = editingSurveyId ? `/api/surveys/${editingSurveyId}` : '/api/surveys';
    
    // Chiamata API per salvare il questionario
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(surveyData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Errore durante il salvataggio del questionario');
        }
        return response.json();
    })
    .then(data => {
        // Reset del form
        editingSurveyId = null;
        questions = [];
        
        // Mostra messaggio di successo
        showAlert(`Questionario ${method === 'POST' ? 'creato' : 'aggiornato'} con successo`, 'success');
        
        // Torna alla lista dei questionari
        navigateTo('surveys');
    })
    .catch(error => {
        showAlert(error.message, 'danger');
    });
}

function resetSurveyForm() {
    console.log('ðŸ”„ resetSurveyForm called - this will clear all form data!'); // Generated by Copilot - Debug log
    
    // Generated by Copilot - Reset completo del form e dello stato di modifica
    document.getElementById('survey-form').reset();
    questions = [];
    editingSurveyId = null;
    editingQuestionIndex = null;
    
    // Reset del titolo della pagina
    document.getElementById('survey-mode-text').textContent = 'Crea nuovo questionario';
    document.getElementById('editing-indicator').style.display = 'none';
    
    renderQuestions();
    console.log('âœ… Form reset complete');
}

function loadUserSurveys() {
    console.log('loadUserSurveys called', currentUser); // Generated by Copilot - Debug log
    
    if (!currentUser) {
        showAlert('Devi effettuare il login per visualizzare i tuoi questionari', 'warning');
        navigateTo('home');
        return;
    }
    
    console.log(`Fetching surveys for user ${currentUser.id}`); // Generated by Copilot - Debug log
    
    fetch(`/api/users/${currentUser.id}/surveys`)
    .then(response => {
        console.log('Response status:', response.status); // Generated by Copilot - Debug log
        if (!response.ok) {
            throw new Error('Errore durante il caricamento dei questionari');
        }
        return response.json();
    })
    .then(surveys => {
        console.log('Surveys loaded:', surveys); // Generated by Copilot - Debug log
        renderUserSurveys(surveys);
    })
    .catch(error => {
        console.error('Error loading surveys:', error); // Generated by Copilot - Debug log
        showAlert(error.message, 'danger');
    });
}

function renderUserSurveys(surveys) {
    const tableBody = document.getElementById('surveys-table-body');
    tableBody.innerHTML = '';
    
    if (surveys.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Nessun questionario disponibile</td></tr>';
        return;
    }
    
    surveys.forEach(survey => {
        const row = document.createElement('tr');
        
        const createdAt = new Date(survey.created_at);
        const formattedDate = createdAt.toLocaleDateString('it-IT') + ' ' + createdAt.toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'});
        
        row.innerHTML = `
            <td>${survey.title}</td>
            <td>${formattedDate}</td>
            <td><span class="badge ${survey.is_active ? 'bg-success' : 'bg-secondary'}">${survey.is_active ? 'Attivo' : 'Inattivo'}</span></td>
            <td><button class="btn btn-sm btn-outline-info view-responses-btn" data-survey-id="${survey.id}">Visualizza</button></td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-primary fill-survey-btn" data-survey-id="${survey.id}">Compila</button>
                    <button class="btn btn-sm btn-outline-secondary edit-survey-btn" data-survey-id="${survey.id}">Modifica</button>
                    <button class="btn btn-sm btn-outline-danger delete-survey-btn" data-survey-id="${survey.id}">Elimina</button>
                </div>
            </td>
        `;
        
        tableBody.appendChild(row);
        
        // Aggiungi event listeners
        row.querySelector('.fill-survey-btn').addEventListener('click', function() {
            loadSurveyToFill(this.getAttribute('data-survey-id'));
        });
        
        row.querySelector('.edit-survey-btn').addEventListener('click', function() {
            loadSurveyToEdit(this.getAttribute('data-survey-id'));
        });
        
        row.querySelector('.delete-survey-btn').addEventListener('click', function() {
            deleteSurvey(this.getAttribute('data-survey-id'));
        });
        
        row.querySelector('.view-responses-btn').addEventListener('click', function() {
            viewSurveyResults(this.getAttribute('data-survey-id'));
        });
    });
}

function loadSurveyToFill(surveyId) {
    fetch(`/api/surveys/${surveyId}`)
    .then(response => {
        if (!response.ok) {
            throw new Error('Errore durante il caricamento del questionario');
        }
        return response.json();
    })
    .then(survey => {
        // Imposta i dati del questionario
        document.getElementById('fill-survey-title').textContent = survey.title;
        document.getElementById('fill-survey-description').textContent = survey.description || 'Nessuna descrizione disponibile';
        
        // Renderizza le domande
        renderSurveyToFill(survey);
        
        // Naviga alla pagina di compilazione
        navigateTo('fill-survey');
    })
    .catch(error => {
        showAlert(error.message, 'danger');
    });
}

function renderSurveyToFill(survey) {
    const container = document.getElementById('fill-questions-container');
    container.innerHTML = '';
    
    survey.questions.sort((a, b) => a.position - b.position).forEach((question, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'fill-question-card';
        questionDiv.dataset.questionId = question.id;
        
        let inputHtml = '';
        
        switch (question.question_type) {
            case 'text':
                inputHtml = `
                    <div class="mb-3">
                        <textarea class="form-control" id="answer-${question.id}" rows="3" ${question.required ? 'required' : ''}></textarea>
                    </div>
                `;
                break;
                
            case 'single_choice':
                inputHtml = '<div class="mb-3">';
                question.options.forEach(option => {
                    inputHtml += `
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question-${question.id}" id="option-${option.id}" value="${option.id}" ${question.required ? 'required' : ''}>
                            <label class="form-check-label" for="option-${option.id}">${option.text}</label>
                        </div>
                    `;
                });
                inputHtml += '</div>';
                break;
                
            case 'multiple_choice':
                inputHtml = '<div class="mb-3">';
                question.options.forEach(option => {
                    inputHtml += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="question-${question.id}" id="option-${option.id}" value="${option.id}">
                            <label class="form-check-label" for="option-${option.id}">${option.text}</label>
                        </div>
                    `;
                });
                inputHtml += '</div>';
                break;
                
            case 'rating':
                inputHtml = `
                    <div class="rating-container">
                        <div class="rating-option">
                            <input type="radio" name="rating-${question.id}" id="rating-${question.id}-1" value="1" ${question.required ? 'required' : ''}>
                            <label for="rating-${question.id}-1">1</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="rating-${question.id}" id="rating-${question.id}-2" value="2" ${question.required ? 'required' : ''}>
                            <label for="rating-${question.id}-2">2</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="rating-${question.id}" id="rating-${question.id}-3" value="3" ${question.required ? 'required' : ''}>
                            <label for="rating-${question.id}-3">3</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="rating-${question.id}" id="rating-${question.id}-4" value="4" ${question.required ? 'required' : ''}>
                            <label for="rating-${question.id}-4">4</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="rating-${question.id}" id="rating-${question.id}-5" value="5" ${question.required ? 'required' : ''}>
                            <label for="rating-${question.id}-5">5</label>
                        </div>
                    </div>
                `;
                break;
        }
        
        questionDiv.innerHTML = `
            <h5>Domanda ${index + 1} ${question.required ? '<span class="required-marker">*</span>' : ''}</h5>
            <p>${question.text}</p>
            ${inputHtml}
        `;
        
        container.appendChild(questionDiv);
    });
    
    // Salva l'ID del questionario nel form
    document.getElementById('fill-survey-form').dataset.surveyId = survey.id;
}

function submitSurveyResponse() {
    const form = document.getElementById('fill-survey-form');
    const surveyId = form.dataset.surveyId;
    
    // Verifica che tutti i campi obbligatori siano compilati
    const requiredInputs = form.querySelectorAll('[required]');
    let allValid = true;
    
    requiredInputs.forEach(input => {
        if (!input.value) {
            input.classList.add('is-invalid');
            allValid = false;
        } else {
            input.classList.remove('is-invalid');
        }
    });
    
    if (!allValid) {
        showAlert('Compila tutti i campi obbligatori', 'danger');
        return;
    }
    
    // Raccogli le risposte
    const answers = [];
    const questionCards = document.querySelectorAll('.fill-question-card');
    
    questionCards.forEach(card => {
        const questionId = card.dataset.questionId;
        const questionType = card.querySelector('textarea, input[type="radio"], input[type="checkbox"]').type;
        
        let answer = {
            question_id: parseInt(questionId)
        };
        
        switch (questionType) {
            case 'textarea':
                answer.text_answer = card.querySelector('textarea').value;
                break;
                
            case 'radio':
                if (card.querySelector('input[name^="rating-"]')) {
                    // Domanda di valutazione
                    const selectedRating = card.querySelector('input[name^="rating-"]:checked');
                    answer.rating_value = selectedRating ? parseInt(selectedRating.value) : null;
                } else {
                    // Domanda a scelta singola
                    const selectedOption = card.querySelector('input[type="radio"]:checked');
                    answer.selected_options = selectedOption ? parseInt(selectedOption.value) : null;
                }
                break;
                
            case 'checkbox':
                // Domanda a scelta multipla
                const selectedOptions = Array.from(card.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(checkbox => parseInt(checkbox.value));
                answer.selected_options = selectedOptions;
                break;
        }
        
        answers.push(answer);
    });
    
    // Prepara i dati della risposta
    const responseData = {
        respondent_id: currentUser ? currentUser.id : null,
        answers: answers
    };
    
    // Invia la risposta
    fetch(`/api/surveys/${surveyId}/responses`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(responseData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Errore durante l\'invio delle risposte');
        }
        return response.json();
    })
    .then(data => {
        showAlert('Risposte inviate con successo', 'success');
        navigateTo('surveys');
    })
    .catch(error => {
        showAlert(error.message, 'danger');
    });
}

function loadSurveyToEdit(surveyId) {
    console.log('ðŸ” loadSurveyToEdit called with surveyId:', surveyId); // Generated by Copilot - Debug log
    
    // Generated by Copilot - Imposta l'ID PRIMA di tutto
    editingSurveyId = surveyId;
    console.log('âœ… editingSurveyId set to:', editingSurveyId);
    
    fetch(`/api/surveys/${surveyId}`)
    .then(response => {
        console.log('ðŸ“¡ Fetch response status:', response.status);
        if (!response.ok) {
            throw new Error('Errore durante il caricamento del questionario');
        }
        return response.json();
    })
    .then(survey => {
        console.log('ðŸ“¦ Survey data received:', survey);
        
        // Generated by Copilot - Prima carica i dati in memoria
        questions = survey.questions.map(q => ({
            id: q.id,
            text: q.text,
            question_type: q.question_type,
            required: q.required,
            options: q.options.map(o => o.text)
        }));
        console.log('â“ Questions loaded in memory:', questions);
        
        // Naviga alla pagina di modifica DOPO aver caricato i dati
        navigateTo('create-survey');
        console.log('ðŸ§­ Navigated to create-survey page');
        
        // Generated by Copilot - Aspetta che la navigazione sia completata prima di popolare
        setTimeout(() => {
            console.log('ðŸ”„ Starting form population after navigation...');
            
            // Generated by Copilot - Aggiorna UI per modalitÃ  modifica
            const modeText = document.getElementById('survey-mode-text');
            const editingIndicator = document.getElementById('editing-indicator');
            
            if (modeText) {
                modeText.textContent = 'Modifica questionario';
                console.log('ðŸ·ï¸ Updated mode text');
            } else {
                console.error('âŒ survey-mode-text element not found!');
            }
            
            if (editingIndicator) {
                editingIndicator.style.display = 'inline';
                console.log('ðŸ·ï¸ Showed editing indicator');
            } else {
                console.error('âŒ editing-indicator element not found!');
            }
            
            // Popola i campi del form
            const titleInput = document.getElementById('survey-title');
            const descInput = document.getElementById('survey-description');
            const activeInput = document.getElementById('survey-active');
            
            console.log('ðŸŽ¯ Found form elements:', {
                titleInput: !!titleInput,
                descInput: !!descInput, 
                activeInput: !!activeInput
            });
            
            if (titleInput) {
                // Generated by Copilot - Forza il focus per assicurarsi che il campo sia attivo
                titleInput.focus();
                titleInput.value = survey.title;
                titleInput.blur();
                console.log('ðŸ“ Set title to:', survey.title, 'Actual value:', titleInput.value);
            } else {
                console.error('âŒ Title input element not found!');
            }
            
            if (descInput) {
                descInput.value = survey.description || '';
                console.log('ðŸ“ Set description to:', survey.description);
            } else {
                console.error('âŒ Description input element not found!');
            }
            
            if (activeInput) {
                activeInput.checked = survey.is_active;
                console.log('â˜‘ï¸ Set active to:', survey.is_active);
            } else {
                console.error('âŒ Active input element not found!');
            }
            
            // Data di scadenza
            if (survey.expires_at) {
                const expiresDate = new Date(survey.expires_at);
                const expiresInput = document.getElementById('survey-expires');
                if (expiresInput) {
                    expiresInput.value = expiresDate.toISOString().split('T')[0];
                    console.log('ðŸ“… Set expires to:', expiresDate.toISOString().split('T')[0]);
                }
            } else {
                const expiresInput = document.getElementById('survey-expires');
                if (expiresInput) {
                    expiresInput.value = '';
                    console.log('ðŸ“… Cleared expires date');
                }
            }
            
            // Renderizza le domande
            renderQuestions();
            console.log('ðŸŽ¨ Questions rendered');
            
            // Generated by Copilot - Verifica finale dopo 200ms
            setTimeout(() => {
                const titleCheck = document.getElementById('survey-title');
                const descCheck = document.getElementById('survey-description');
                console.log('ðŸ” FINAL CHECK - Title:', titleCheck?.value, 'Desc:', descCheck?.value);
                console.log('ðŸ” FINAL CHECK - editingSurveyId:', editingSurveyId);
                console.log('ï¿½ FINAL CHECK - questions count:', questions.length);
            }, 200);
            
        }, 250); // Generated by Copilot - Aspetta piÃ¹ a lungo per essere sicuri
    })
    .catch(error => {
        console.error('âŒ Error in loadSurveyToEdit:', error);
        editingSurveyId = null; // Reset in caso di errore
        showAlert(error.message, 'danger');
    });
}

function deleteSurvey(surveyId) {
    if (!confirm('Sei sicuro di voler eliminare questo questionario?')) {
        return;
    }
    
    fetch(`/api/surveys/${surveyId}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Errore durante l\'eliminazione del questionario');
        }
        return response.json();
    })
    .then(data => {
        showAlert('Questionario eliminato con successo', 'success');
        loadUserSurveys();
    })
    .catch(error => {
        showAlert(error.message, 'danger');
    });
}

// Funzioni per la gestione dei risultati
function setupResults() {
    // Gestione della selezione del questionario per i risultati
    document.getElementById('select-survey-results').addEventListener('change', function() {
        const surveyId = this.value;
        if (surveyId) {
            loadSurveyResults(surveyId);
            document.getElementById('export-results-btn').disabled = false;
            document.getElementById('print-results-btn').disabled = false; // Generated by Copilot
        } else {
            document.getElementById('results-container').classList.add('d-none');
            document.getElementById('no-results-message').classList.remove('d-none');
            document.getElementById('export-results-btn').disabled = true;
            document.getElementById('print-results-btn').disabled = true; // Generated by Copilot
        }
    });
    
    // Gestione dell'esportazione dei risultati
    document.getElementById('export-results-btn').addEventListener('click', function() {
        const surveyId = document.getElementById('select-survey-results').value;
        if (surveyId) {
            exportSurveyResults(surveyId);
        }
    });
    
    // Generated by Copilot - Gestione della stampa dei risultati
    document.getElementById('print-results-btn').addEventListener('click', function() {
        const surveyId = document.getElementById('select-survey-results').value;
        if (surveyId) {
            printSurveyResults();
        }
    });
    
    document.getElementById('print-single-results-btn').addEventListener('click', function() {
        printSurveyResults();
    });
    
    document.getElementById('export-single-results-btn').addEventListener('click', function() {
        const surveyId = this.getAttribute('data-survey-id');
        if (surveyId) {
            exportSurveyResults(surveyId);
        }
    });
}

function loadSurveysForResults() {
    if (!currentUser) {
        showAlert('Devi effettuare il login per visualizzare i risultati', 'warning');
        navigateTo('home');
        return;
    }
    
    fetch(`/api/users/${currentUser.id}/surveys`)
    .then(response => {
        if (!response.ok) {
            throw new Error('Errore durante il caricamento dei questionari');
        }
        return response.json();
    })
    .then(surveys => {
        const select = document.getElementById('select-survey-results');
        select.innerHTML = '<option value="">Seleziona un questionario...</option>';
        
        surveys.forEach(survey => {
            const option = document.createElement('option');
            option.value = survey.id;
            option.textContent = survey.title;
            select.appendChild(option);
        });
    })
    .catch(error => {
        showAlert(error.message, 'danger');
    });
}

function loadSurveyResults(surveyId) {
    fetch(`/api/surveys/${surveyId}/results`)
    .then(response => {
        if (!response.ok) {
            throw new Error('Errore durante il caricamento dei risultati');
        }
        return response.json();
    })
    .then(results => {
        renderSurveyResults(results);
    })
    .catch(error => {
        showAlert(error.message, 'danger');
    });
}

function renderSurveyResults(results) {
    // Mostra il container dei risultati
    document.getElementById('results-container').classList.remove('d-none');
    document.getElementById('no-results-message').classList.add('d-none');
    
    // Imposta il titolo e il numero di risposte
    document.getElementById('results-survey-title').textContent = results.title;
    document.getElementById('results-total-responses').textContent = `${results.total_responses} risposte`;
    
    // Crea il grafico di panoramica
    createOverviewChart(results);
    
    // Crea il grafico temporale (simulato, in un'app reale useremmo dati temporali reali)
    createTimelineChart();
    
    // Renderizza i risultati per ogni domanda
    renderQuestionResults(results.questions);
    
    // Imposta l'ID del questionario per l'esportazione
    document.getElementById('export-single-results-btn').setAttribute('data-survey-id', results.survey_id);
}

function createOverviewChart(results) {
    const ctx = document.getElementById('overview-chart').getContext('2d');
    
    // Distruggi il grafico esistente se presente
    if (window.overviewChart) {
        window.overviewChart.destroy();
    }
    
    // Crea dati per il grafico a torta
    const questionTypes = {
        text: 0,
        single_choice: 0,
        multiple_choice: 0,
        rating: 0
    };
    
    results.questions.forEach(question => {
        questionTypes[question.question_type]++;
    });
    
    window.overviewChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: [
                'Domande testuali',
                'Domande a scelta singola',
                'Domande a scelta multipla',
                'Domande con valutazione'
            ],
            datasets: [{
                data: [
                    questionTypes.text,
                    questionTypes.single_choice,
                    questionTypes.multiple_choice,
                    questionTypes.rating
                ],
                backgroundColor: [
                    '#36a2eb',
                    '#ff6384',
                    '#4bc0c0',
                    '#ffcd56'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Distribuzione tipi di domande'
                }
            }
        }
    });
}

function createTimelineChart() {
    const ctx = document.getElementById('timeline-chart').getContext('2d');
    
    // Distruggi il grafico esistente se presente
    if (window.timelineChart) {
        window.timelineChart.destroy();
    }
    
    // Crea dati simulati per il grafico temporale
    const days = 7;
    const labels = [];
    const data = [];
    
    const today = new Date();
    for (let i = days - 1; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('it-IT', {day: 'numeric', month: 'short'}));
        
        // Dati casuali per la simulazione
        data.push(Math.floor(Math.random() * 10));
    }
    
    window.timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Risposte ricevute',
                data: data,
                borderColor: '#4bc0c0',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Risposte negli ultimi 7 giorni'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

function renderQuestionResults(questions) {
    const container = document.getElementById('question-results-container');
    container.innerHTML = '';
    
    questions.forEach((question, index) => {
        const card = document.createElement('div');
        card.className = 'card result-card';
        
        let resultContent = '';
        let chartHtml = '';
        
        switch (question.question_type) {
            case 'text':
                // Per domande testuali, mostra le ultime risposte
                resultContent = `
                    <div class="text-answers-container">
                        ${question.text_answers && question.text_answers.length > 0 
                            ? question.text_answers.map(answer => `<div class="text-answer-item">${answer}</div>`).join('')
                            : '<p class="text-muted">Nessuna risposta testuale disponibile</p>'}
                    </div>
                `;
                break;
                
            case 'single_choice':
            case 'multiple_choice':
                // Per domande a scelta, mostra un grafico a barre
                chartHtml = `<div class="chart-container"><canvas id="question-chart-${question.id}"></canvas></div>`;
                break;
                
            case 'rating':
                // Per domande con valutazione, mostra media e distribuzione
                chartHtml = `<div class="chart-container"><canvas id="question-chart-${question.id}"></canvas></div>`;
                resultContent = `
                    <div class="mt-3">
                        <strong>Valutazione media:</strong> ${question.average_rating || 'N/A'}
                    </div>
                `;
                break;
        }
        
        card.innerHTML = `
            <div class="card-header">
                <h5 class="mb-0">Domanda ${index + 1}: ${question.text}</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="badge ${question.question_type === 'text' ? 'bg-info' : 
                                        question.question_type === 'single_choice' ? 'bg-primary' : 
                                        question.question_type === 'multiple_choice' ? 'bg-success' : 'bg-warning'}">
                        ${question.question_type === 'text' ? 'Testo' : 
                          question.question_type === 'single_choice' ? 'Scelta singola' : 
                          question.question_type === 'multiple_choice' ? 'Scelta multipla' : 'Valutazione'}
                    </span>
                    <span class="badge bg-secondary">${question.total_answers} risposte</span>
                </div>
                ${chartHtml}
                ${resultContent}
            </div>
        `;
        
        container.appendChild(card);
        
        // Crea i grafici per le domande che lo richiedono
        if (question.question_type === 'single_choice' || question.question_type === 'multiple_choice') {
            createOptionsChart(question);
        } else if (question.question_type === 'rating') {
            createRatingChart(question);
        }
    });
}

function createOptionsChart(question) {
    const ctx = document.getElementById(`question-chart-${question.id}`).getContext('2d');
    
    const labels = question.options.map(option => option.text);
    const data = question.options.map(option => option.count);
    const backgroundColors = generateColors(labels.length);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Risposte',
                data: data,
                backgroundColor: backgroundColors
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const percentage = question.options[context.dataIndex].percentage;
                            return `${value} risposte (${percentage}%)`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

function createRatingChart(question) {
    const ctx = document.getElementById(`question-chart-${question.id}`).getContext('2d');
    
    const labels = Object.keys(question.distribution).map(key => `${key} stelle`);
    const data = Object.values(question.distribution);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Risposte',
                data: data,
                backgroundColor: '#ffcd56'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Distribuzione valutazioni'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

function viewSurveyResults(surveyId) {
    // Carica i risultati del questionario
    fetch(`/api/surveys/${surveyId}/results`)
    .then(response => {
        if (!response.ok) {
            throw new Error('Errore durante il caricamento dei risultati');
        }
        return response.json();
    })
    .then(results => {
        // Imposta il titolo e il numero di risposte
        document.getElementById('view-results-title').textContent = `Risultati: ${results.title}`;
        document.getElementById('view-total-responses').textContent = `${results.total_responses} risposte`;
        
        // Crea i grafici
        createViewOverviewChart(results);
        createViewTimelineChart();
        
        // Renderizza i risultati dettagliati
        renderViewQuestionResults(results.questions);
        
        // Imposta l'ID del questionario per l'esportazione
        document.getElementById('export-single-results-btn').setAttribute('data-survey-id', results.survey_id);
        
        // Naviga alla pagina di visualizzazione risultati
        navigateTo('view-results');
    })
    .catch(error => {
        showAlert(error.message, 'danger');
    });
}

function createViewOverviewChart(results) {
    const ctx = document.getElementById('view-overview-chart').getContext('2d');
    
    // Distruggi il grafico esistente se presente
    if (window.viewOverviewChart) {
        window.viewOverviewChart.destroy();
    }
    
    // Crea dati per il grafico a torta
    const questionTypes = {
        text: 0,
        single_choice: 0,
        multiple_choice: 0,
        rating: 0
    };
    
    results.questions.forEach(question => {
        questionTypes[question.question_type]++;
    });
    
    window.viewOverviewChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: [
                'Domande testuali',
                'Domande a scelta singola',
                'Domande a scelta multipla',
                'Domande con valutazione'
            ],
            datasets: [{
                data: [
                    questionTypes.text,
                    questionTypes.single_choice,
                    questionTypes.multiple_choice,
                    questionTypes.rating
                ],
                backgroundColor: [
                    '#36a2eb',
                    '#ff6384',
                    '#4bc0c0',
                    '#ffcd56'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Distribuzione tipi di domande'
                }
            }
        }
    });
}

function createViewTimelineChart() {
    const ctx = document.getElementById('view-timeline-chart').getContext('2d');
    
    // Distruggi il grafico esistente se presente
    if (window.viewTimelineChart) {
        window.viewTimelineChart.destroy();
    }
    
    // Crea dati simulati per il grafico temporale
    const days = 7;
    const labels = [];
    const data = [];
    
    const today = new Date();
    for (let i = days - 1; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('it-IT', {day: 'numeric', month: 'short'}));
        
        // Dati casuali per la simulazione
        data.push(Math.floor(Math.random() * 10));
    }
    
    window.viewTimelineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Risposte ricevute',
                data: data,
                borderColor: '#4bc0c0',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Risposte negli ultimi 7 giorni'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

function renderViewQuestionResults(questions) {
    const container = document.getElementById('view-question-results');
    container.innerHTML = '';
    
    questions.forEach((question, index) => {
        const card = document.createElement('div');
        card.className = 'card mb-4';
        
        let resultContent = '';
        let chartHtml = '';
        
        switch (question.question_type) {
            case 'text':
                // Per domande testuali, mostra le ultime risposte
                resultContent = `
                    <div class="text-answers-container mt-3">
                        ${question.text_answers && question.text_answers.length > 0 
                            ? question.text_answers.map(answer => `<div class="text-answer-item">${answer}</div>`).join('')
                            : '<p class="text-muted">Nessuna risposta testuale disponibile</p>'}
                    </div>
                `;
                break;
                
            case 'single_choice':
            case 'multiple_choice':
                // Per domande a scelta, mostra un grafico a barre e un grafico a torta
                chartHtml = `
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <canvas id="view-bar-chart-${question.id}"></canvas>
                        </div>
                        <div class="col-md-6">
                            <canvas id="view-pie-chart-${question.id}"></canvas>
                        </div>
                    </div>
                `;
                break;
                
            case 'rating':
                // Per domande con valutazione, mostra media e distribuzione
                chartHtml = `
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <canvas id="view-bar-chart-${question.id}"></canvas>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center justify-content-center h-100">
                                <div class="text-center">
                                    <h1 class="display-1">${question.average_rating || 'N/A'}</h1>
                                    <p class="lead">Valutazione media</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                break;
        }
        
        card.innerHTML = `
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Domanda ${index + 1}: ${question.text}</h5>
                    <div>
                        <span class="badge ${question.question_type === 'text' ? 'bg-info' : 
                                            question.question_type === 'single_choice' ? 'bg-primary' : 
                                            question.question_type === 'multiple_choice' ? 'bg-success' : 'bg-warning'}">
                            ${question.question_type === 'text' ? 'Testo' : 
                              question.question_type === 'single_choice' ? 'Scelta singola' : 
                              question.question_type === 'multiple_choice' ? 'Scelta multipla' : 'Valutazione'}
                        </span>
                        <span class="badge bg-secondary ms-1">${question.total_answers} risposte</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                ${chartHtml}
                ${resultContent}
            </div>
        `;
        
        container.appendChild(card);
        
        // Crea i grafici per le domande che lo richiedono
        if (question.question_type === 'single_choice' || question.question_type === 'multiple_choice') {
            createViewOptionsCharts(question);
        } else if (question.question_type === 'rating') {
            createViewRatingChart(question);
        }
    });
}

function createViewOptionsCharts(question) {
    // Grafico a barre
    const barCtx = document.getElementById(`view-bar-chart-${question.id}`).getContext('2d');
    
    const labels = question.options.map(option => option.text);
    const data = question.options.map(option => option.count);
    const backgroundColors = generateColors(labels.length);
    
    new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Risposte',
                data: data,
                backgroundColor: backgroundColors
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Distribuzione risposte'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const percentage = question.options[context.dataIndex].percentage;
                            return `${value} risposte (${percentage}%)`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
    
    // Grafico a torta
    const pieCtx = document.getElementById(`view-pie-chart-${question.id}`).getContext('2d');
    
    new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Percentuali risposte'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const percentage = question.options[context.dataIndex].percentage;
                            return `${value} risposte (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function createViewRatingChart(question) {
    const ctx = document.getElementById(`view-bar-chart-${question.id}`).getContext('2d');
    
    const labels = Object.keys(question.distribution).map(key => `${key} stelle`);
    const data = Object.values(question.distribution);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Risposte',
                data: data,
                backgroundColor: '#ffcd56'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Distribuzione valutazioni'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

function exportSurveyResults(surveyId) {
    // Prima recupera i formati disponibili
    fetch(`/api/surveys/${surveyId}/responses/export/formats`)
    .then(response => {
        if (!response.ok) {
            throw new Error('Errore durante il recupero dei formati di export');
        }
        return response.json();
    })
    .then(data => {
        // Mostra modal con opzioni di export
        showExportModal(surveyId, data);
    })
    .catch(error => {
        showAlert(error.message, 'danger');
    });
}

function showExportModal(surveyId, exportData) {
    // Crea modal dinamico per la selezione del formato
    const modalHtml = `
        <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exportModalLabel">
                            <i class="bi bi-download me-2"></i>Esporta Risultati
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <h6><i class="bi bi-clipboard-data me-2"></i>${exportData.survey_title}</h6>
                            <p class="text-muted mb-3">
                                <i class="bi bi-people me-1"></i>
                                ${exportData.total_responses} ${exportData.total_responses === 1 ? 'risposta' : 'risposte'} disponibili
                            </p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Seleziona formato di export:</label>
                            <div class="row g-3">
                                ${exportData.available_formats.map(format => `
                                    <div class="col-md-6">
                                        <div class="card export-format-card h-100" data-format="${format.format}">
                                            <div class="card-body text-center">
                                                <i class="bi ${format.format === 'json' ? 'bi-filetype-json' : 'bi-filetype-csv'} fs-1 text-primary mb-2"></i>
                                                <h6 class="card-title">${format.name}</h6>
                                                <p class="card-text small text-muted">${format.description}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-2"></i>Annulla
                        </button>
                        <button type="button" class="btn btn-primary" id="startExportBtn" disabled>
                            <i class="bi bi-download me-2"></i>Scarica
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Rimuovi modal esistente se presente
    const existingModal = document.getElementById('exportModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Aggiungi nuovo modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Inizializza modal
    const modal = new bootstrap.Modal(document.getElementById('exportModal'));
    
    // Gestisci selezione formato
    let selectedFormat = null;
    document.querySelectorAll('.export-format-card').forEach(card => {
        card.addEventListener('click', function() {
            // Rimuovi selezione precedente
            document.querySelectorAll('.export-format-card').forEach(c => 
                c.classList.remove('border-primary', 'bg-light'));
            
            // Aggiungi selezione corrente
            this.classList.add('border-primary', 'bg-light');
            selectedFormat = this.dataset.format;
            
            // Abilita pulsante download
            document.getElementById('startExportBtn').disabled = false;
        });
    });
    
    // Gestisci download
    document.getElementById('startExportBtn').addEventListener('click', function() {
        if (selectedFormat) {
            modal.hide();
            downloadExport(surveyId, selectedFormat, exportData.available_formats);
        }
    });
    
    // Aggiungi stili CSS per le card
    if (!document.getElementById('export-modal-styles')) {
        const styles = document.createElement('style');
        styles.id = 'export-modal-styles';
        styles.textContent = `
            .export-format-card {
                cursor: pointer;
                transition: all 0.3s ease;
                border: 2px solid transparent;
            }
            .export-format-card:hover {
                border-color: var(--bs-primary);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            .export-format-card.border-primary {
                border-color: var(--bs-primary) !important;
            }
        `;
        document.head.appendChild(styles);
    }
    
    modal.show();
}

function downloadExport(surveyId, format, availableFormats) {
    const formatInfo = availableFormats.find(f => f.format === format);
    if (!formatInfo) {
        showAlert('Formato non valido', 'danger');
        return;
    }
    
    // Mostra indicatore di caricamento
    showAlert(`<i class="bi bi-hourglass-split me-2"></i>Preparazione export ${formatInfo.name}...`, 'info');
    
    if (format === 'csv') {
        // Per CSV, fai download diretto del file
        const link = document.createElement('a');
        link.href = formatInfo.endpoint;
        link.download = `questionario_${surveyId}_risposte.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert(`<i class="bi bi-check-circle me-2"></i>Export ${formatInfo.name} completato!`, 'success');
        
    } else if (format === 'json') {
        // Per JSON, usa fetch per il controllo errori
        fetch(formatInfo.endpoint)
        .then(response => {
            if (!response.ok) {
                throw new Error('Errore durante l\'esportazione');
            }
            return response.json();
        })
        .then(data => {
            // Crea file JSON per download
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `questionario_${surveyId}_risposte.json`;
            document.body.appendChild(link);
            link.click();
            
            // Cleanup
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showAlert(`<i class="bi bi-check-circle me-2"></i>Export ${formatInfo.name} completato!`, 'success');
        })
        .catch(error => {
            showAlert(`Errore durante l'export: ${error.message}`, 'danger');
        });
    }
}

// Funzioni di utilitÃ 
function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    alertContainer.appendChild(alert);
    
    // Rimuovi l'alert dopo 5 secondi
    setTimeout(() => {
        alert.classList.remove('show');
        setTimeout(() => {
            alertContainer.removeChild(alert);
        }, 150);
    }, 5000);
}

function generateColors(count) {
    const colors = [
        '#ff6384', '#36a2eb', '#4bc0c0', '#ffcd56', '#ff9f40',
        '#9966ff', '#c9cbcf', '#7cbb00', '#00a4ef', '#f25022'
    ];
    
    // Se ci sono piÃ¹ opzioni che colori, ripeti i colori
    const result = [];
    for (let i = 0; i < count; i++) {
        result.push(colors[i % colors.length]);
    }
    
    return result;
}

function loadInitialData() {
    console.log('loadInitialData called', currentUser); // Generated by Copilot - Debug log
    
    // Carica i questionari recenti per la home
    if (currentUser) {
        console.log(`Loading initial data for user ${currentUser.id}`); // Generated by Copilot - Debug log
        
        fetch(`/api/users/${currentUser.id}/surveys`)
        .then(response => {
            console.log('Initial data response status:', response.status); // Generated by Copilot - Debug log
            if (!response.ok) {
                throw new Error('Errore durante il caricamento dei questionari');
            }
            return response.json();
        })
        .then(surveys => {
            console.log('Initial surveys loaded:', surveys); // Generated by Copilot - Debug log
            renderRecentSurveys(surveys.slice(0, 5));
        })
        .catch(error => {
            console.error('Error loading initial data:', error); // Generated by Copilot - Debug log
        });
    } else {
        console.log('No current user for initial data load'); // Generated by Copilot - Debug log
    }
}

function renderRecentSurveys(surveys) {
    const container = document.getElementById('recent-surveys-list');
    
    if (!surveys || surveys.length === 0) {
        container.innerHTML = '<p class="text-muted">Nessun questionario disponibile</p>';
        return;
    }
    
    container.innerHTML = '';
    
    surveys.forEach(survey => {
        const item = document.createElement('div');
        item.className = 'mb-2';
        
        const createdAt = new Date(survey.created_at);
        const formattedDate = createdAt.toLocaleDateString('it-IT');
        
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <a href="#" class="text-decoration-none fill-recent-survey" data-survey-id="${survey.id}">${survey.title}</a>
                <span class="badge ${survey.is_active ? 'bg-success' : 'bg-secondary'}">${survey.is_active ? 'Attivo' : 'Inattivo'}</span>
            </div>
            <small class="text-muted">Creato il ${formattedDate}</small>
        `;
        
        container.appendChild(item);
        
        // Aggiungi event listener
        item.querySelector('.fill-recent-survey').addEventListener('click', function(e) {
            e.preventDefault();
            loadSurveyToFill(this.getAttribute('data-survey-id'));
        });
    });
}

// Generated by Copilot - Funzione per stampare i risultati del questionario
function printSurveyResults() {
    console.log('ðŸ–¨ï¸ printSurveyResults called');
    
    // Mostra un messaggio di feedback all'utente
    showAlert('Preparazione del documento per la stampa...', 'info');
    
    // Prepara il contenuto per la stampa
    preparePrintContent();
    
    // Aspetta che i grafici siano renderizzati prima di stampare
    setTimeout(() => {
        console.log('ðŸ–¨ï¸ Starting print process...');
        showAlert('Apertura della finestra di stampa...', 'success');
        
        // Apri la finestra di stampa
        window.print();
        
        // Messaggio dopo la stampa (mostrato dopo un breve delay)
        setTimeout(() => {
            showAlert('Stampa completata! Verifica che tutti i grafici siano visibili.', 'success');
        }, 1000);
    }, 500);
}

function preparePrintContent() {
    console.log('ðŸ“„ Preparing print content...');
    
    // Aggiungi intestazione di stampa se non esiste giÃ 
    let printHeader = document.querySelector('.print-header');
    if (!printHeader) {
        printHeader = document.createElement('div');
        printHeader.className = 'print-header d-none d-print-block';
        
        const surveyTitle = document.getElementById('results-survey-title')?.textContent || 
                          document.getElementById('view-results-title')?.textContent || 
                          'Risultati Questionario';
        
        const totalResponses = document.getElementById('results-total-responses')?.textContent || '0 risposte';
        
        printHeader.innerHTML = `
            <h1>Risultati del Questionario</h1>
            <h2>${surveyTitle}</h2>
            <p><strong>${totalResponses}</strong></p>
            <div class="print-date">
                Stampato il: ${new Date().toLocaleDateString('it-IT')} alle ${new Date().toLocaleTimeString('it-IT')}
            </div>
        `;
        
        // Inserisci l'intestazione all'inizio del contenuto dei risultati
        const resultsContainer = document.getElementById('results-container') || 
                                document.querySelector('#view-results-page .card');
        if (resultsContainer) {
            resultsContainer.insertBefore(printHeader, resultsContainer.firstChild);
        }
    }
    
    // Generated by Copilot - Popola la sezione riassuntiva per la stampa
    populatePrintSummary();
    
    // Aggiungi classi per evitare interruzioni di pagina indesiderate
    const questionResults = document.querySelectorAll('.card, .question-result, .mb-4');
    questionResults.forEach(element => {
        element.classList.add('no-break');
    });
    
    // Converti i canvas dei grafici in immagini per la stampa
    convertChartsForPrint();
}

// Generated by Copilot - Funzione per popolare il riassunto di stampa
function populatePrintSummary() {
    console.log('ðŸ“‹ Populating print summary...');
    
    try {
        // Data di creazione (se disponibile)
        const printCreated = document.getElementById('print-survey-created');
        if (printCreated) {
            printCreated.textContent = new Date().toLocaleDateString('it-IT'); // Placeholder
        }
        
        // Stato del questionario
        const printStatus = document.getElementById('print-survey-status');
        if (printStatus) {
            printStatus.textContent = 'Attivo'; // Placeholder
        }
        
        // Totale domande
        const printTotalQuestions = document.getElementById('print-total-questions');
        if (printTotalQuestions) {
            const questionCount = document.querySelectorAll('#question-results-container .card, [id^="view-question-"]').length;
            printTotalQuestions.textContent = questionCount.toString();
        }
        
        // Totale risposte
        const printTotalResponses = document.getElementById('print-total-responses');
        const responsesText = document.getElementById('results-total-responses')?.textContent || 
                             document.getElementById('view-total-responses')?.textContent || 
                             '0 risposte';
        if (printTotalResponses) {
            printTotalResponses.textContent = responsesText;
        }
        
        console.log('ðŸ“‹ Print summary populated successfully');
    } catch (error) {
        console.error('âŒ Error populating print summary:', error);
    }
}

function convertChartsForPrint() {
    console.log('ðŸ“Š Converting charts for print...');
    
    const canvases = document.querySelectorAll('canvas');
    canvases.forEach(canvas => {
        try {
            // Crea un'immagine dal canvas
            const dataURL = canvas.toDataURL('image/png', 1.0);
            
            // Crea un elemento img
            const img = document.createElement('img');
            img.src = dataURL;
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.className = 'print-chart';
            
            // Nascondi il canvas durante la stampa
            canvas.style.display = 'none';
            canvas.classList.add('d-print-none');
            
            // Inserisci l'immagine dopo il canvas
            canvas.parentNode.insertBefore(img, canvas.nextSibling);
            
            console.log('ðŸ“Š Converted chart to image for printing');
        } catch (error) {
            console.error('âŒ Error converting chart to image:', error);
        }
    });
}

// Generated by Copilot - Funzione per pulire il contenuto dopo la stampa
function cleanupAfterPrint() {
    console.log('ðŸ§¹ Cleaning up after print...');
    
    // Rimuovi le immagini dei grafici create per la stampa
    const printCharts = document.querySelectorAll('.print-chart');
    printCharts.forEach(img => img.remove());
    
    // Ripristina la visibilitÃ  dei canvas
    const canvases = document.querySelectorAll('canvas');
    canvases.forEach(canvas => {
        canvas.style.display = '';
        canvas.classList.remove('d-print-none');
    });
}

// Aggiungi listener per pulire dopo la stampa
window.addEventListener('afterprint', cleanupAfterPrint);

// Generated by Copilot - Funzione per aggiornare l'indicatore di menu attivo
function updateActiveMenuItem(activePage) {
    // Rimuovi la classe active da tutti i link del menu
    document.querySelectorAll('.nav-link[data-page]').forEach(link => {
        link.classList.remove('active');
    });
    
    // Aggiungi la classe active al link della pagina corrente
    const activeLink = document.querySelector(`.nav-link[data-page="${activePage}"]`);
    if (activeLink) {
        activeLink.classList.add('active');
        console.log('ðŸŽ¯ Updated active menu item for page:', activePage);
        
        // Aggiungi un effetto di pulsazione per evidenziare il cambio
        activeLink.style.animation = 'none';
        setTimeout(() => {
            activeLink.style.animation = 'pulse 0.6s ease-in-out';
        }, 10);
    }
}

// Generated by Copilot - Funzione per inizializzare il menu con animazioni
function initializeMenuAnimations() {
    // Aggiungi effetti hover personalizzati
    const navLinks = document.querySelectorAll('.nav-link-hover');
    
    navLinks.forEach(link => {
        // Effetto di caricamento al click
        link.addEventListener('click', function(e) {
            const icon = this.querySelector('i');
            if (icon) {
                icon.style.animation = 'spin 0.5s ease-in-out';
                setTimeout(() => {
                    icon.style.animation = '';
                }, 500);
            }
        });
        
        // Effetto tooltip personalizzato
        link.addEventListener('mouseenter', function() {
            const text = this.querySelector('span').textContent;
            this.setAttribute('title', `Vai a: ${text}`);
        });
    });
    
    // Effetti per i pulsanti di autenticazione
    const authButtons = document.querySelectorAll('#auth-buttons .btn, #user-info .btn');
    authButtons.forEach(button => {
        button.addEventListener('click', function() {
            const icon = this.querySelector('i');
            if (icon) {
                icon.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    icon.style.transform = '';
                }, 150);
            }
        });
    });
    
    console.log('ðŸŽ¨ Menu animations initialized');
}

// Aggiungi animazione CSS per il pulse e spin
const style = document.createElement('style');
style.textContent = `
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
