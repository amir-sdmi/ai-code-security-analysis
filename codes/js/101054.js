import dotenv from "dotenv";
import express from "express";
import cors from "cors";
import bodyParser from "body-parser";
import rateLimit from "express-rate-limit";
import { GoogleGenAI } from "@google/genai";
import fs from "fs";
import path from "path";

dotenv.config();

const app = express();
const port = process.env.PORT || 5000;

app.use(cors());
app.use(bodyParser.json());

const limiter = rateLimit({
    windowMs: 60 * 1000,
    max: 30,
    message: { error: "Too many requests. Please try again later." },
});
app.use("/chat", limiter);

const genAI = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY });

// Read system prompt from file
const SYSTEM_PROMPT = fs.readFileSync(
    path.resolve("system_prompt.txt"),
    "utf-8"
);

app.get("/", (req, res) => {
    res.send("Server running...");
});

app.post("/chat", async (req, res) => {
    const { chat } = req.body;

    if (!Array.isArray(chat) || chat.length === 0) {
        return res.status(400).json({ error: "Invalid chat history." });
    }

    try {
        const contents = [
            {
                role: "user",
                parts: [{ text: SYSTEM_PROMPT }],
            },
            ...chat.map((msg) => ({
                role: msg.role,
                parts: [{ text: msg.content }],
            })),
        ];

        const result = await genAI.models.generateContent({
            model: "gemini-2.0-flash",
            contents,
        });

        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

        if (!text) {
            console.error(
                "Unexpected response structure:",
                JSON.stringify(result, null, 2)
            );
            return res
                .status(500)
                .json({ error: "No response generated by Gemini." });
        }

        res.json({ response: text });
    } catch (error) {
        console.error("Gemini API error:", error.message || error);
        res.status(500).json({
            error: "Something went wrong while generating the response.",
        });
    }
});

app.listen(port, () => {
    console.log(`âœ… Server running at http://localhost:${port}`);
});
