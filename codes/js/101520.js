document.addEventListener('DOMContentLoaded', () => {
    // Get the story ID from the URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const storyId = urlParams.get('id');

    // Display the story title at the top of the page
    const storyTitleElement = document.getElementById('story-title');

    // Create 20 tabs
    const tabButtons = document.querySelector('.tab-buttons');
    const tabContents = document.querySelector('.tab-contents');

    for (let i = 1; i <= 20; i++) {
        // Create tab button
        const tabButton = document.createElement('button');
        tabButton.textContent = `Tab ${i}`;
        tabButton.dataset.tab = i;
        tabButtons.appendChild(tabButton);

        // Create tab content
        const tabContent = document.createElement('div');
        tabContent.classList.add('tab');
        tabContent.dataset.tab = i;
        tabContent.textContent = "Memproses...";
        tabContents.appendChild(tabContent);

        // Add active class to the first tab
        if (i === 1) {
            tabButton.classList.add('active');
            tabContent.classList.add('active');
        }

        // Add event listener to tab button
        tabButton.addEventListener('click', () => {
            // Remove active class from all tab buttons and tab contents
            document.querySelectorAll('.tab-buttons button').forEach(button => button.classList.remove('active'));
            document.querySelectorAll('.tab-contents .tab').forEach(tab => tab.classList.remove('active'));

            // Add active class to the clicked tab button and tab content
            tabButton.classList.add('active');
            tabContent.classList.add('active');
        });
    }

    // Retrieve story from localforage
    localforage.getItem('cerita').then(stories => {
        const story = stories.find(story => story.id === storyId);

        // Populate story title
        storyTitleElement.textContent = story.judul;
    });

    // Function to call Gemini API
    async function getGeminiResponse(prompt) {
        const apiKey = localStorage.getItem('gemini');
        const model = 'gemini-2.0-flash';
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

        const data = {
            contents: [{
                parts: [{
                    text: prompt
                }]
            }]
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const json = await response.json();
            if (json.candidates && json.candidates.length > 0 && json.candidates[0].content && json.candidates[0].content.parts && json.candidates[0].content.parts.length > 0) {
                return json.candidates[0].content.parts[0].text;
            } else {
                console.error('Error: Invalid Gemini API response:', json);
                return 'Error: Invalid Gemini API response';
            }
        } catch (error) {
            console.error('Error calling Gemini API:', error);
            return `Error: ${error.message}`;
        }
    }

    // Function to generate and display stories
    async function generateAndDisplayStories() {
        console.log("Generating narratives with Gemini...");
        const initialPrompt = `Buatkan kisah ${storyTitleElement.textContent}. Buatkan 20 narasi`;
        const narratives = [];

        // Get narratives from localforage or Gemini
        for (let i = 1; i <= 20; i++) {
            const narrativeKey = i.toString();
            let narrative = await localforage.getItem(narrativeKey);

            if (narrative && narrative !== 'Memproses...') {
                narratives[i - 1] = narrative;
                console.log(`Narrative ${i} loaded from localforage`);
            } else {
                if (i === 1) {
                    // Expand narrative 1 and generate image prompt
                    const narrative1Prompt = `Kembangkan cerita di atas di bagian narasi 1 menjadi 3000 karakter. Sebelum itu, berikan teks ilustrasi gambar pada cerita di narasi 1`;
                    narrative = await getGeminiResponse(narrative1Prompt);
                } else {
                    const previousNarrative = narratives[i - 2];
                    const narrativePrompt = `Kembangkan cerita dengan judul "${storyTitleElement.textContent}" berikut ini menjadi 3000 karakter: ${previousNarrative}. Buat narasi ${i}`;
                    narrative = await getGeminiResponse(narrativePrompt);
                }

                narratives[i - 1] = narrative;
                console.log(`Narrative ${i} generated by Gemini and stored in localforage`);

                // Store results in localforage and update story object
                localforage.getItem('cerita').then(stories => {
                    const storyIndex = stories.findIndex(story => story.id === storyId);
                    const story = stories[storyIndex];

                    story[i] = narratives[i - 1]; // Update story object
                    stories[storyIndex] = story; // Update story in array
                    return localforage.setItem('cerita', stories); // Save updated array
                }).then(() => {
                    // Populate tab content
                    const tabContents = document.querySelector('.tab-contents');
                    const tabContent = tabContents.querySelector(`[data-tab="${i}"]`);
                    tabContent.textContent = narratives[i - 1];
                });
            }
        }
    }

    // Call generateAndDisplayStories after populating the story title
    localforage.getItem('cerita').then(stories => {
        const story = stories.find(story => story.id === storyId);

        // Populate story title
        storyTitleElement.textContent = story.judul;

        generateAndDisplayStories();
    });
});
